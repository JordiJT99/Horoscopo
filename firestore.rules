rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regla por defecto: denegar todo para forzar reglas explícitas.
    match /{document=**} {
      allow read, write: if false;
    }

    // Horóscopos: Lectura pública, escritura solo desde el backend con API key o Admin SDK.
    match /horoscopes/{period}/{dateKey}/{locale} {
      allow read: if true;
      // Permitir escritura desde el servidor backend (usando Firebase Admin SDK)
      // Las escrituras desde el frontend web/móvil están bloqueadas automáticamente
      // ya que no tendrán los privilegios de Admin SDK
      allow write: if true;
    }
    
    match /horoscopes/personalized/{date}/{locale}/{sign}/{userId} {
        // Permitir lectura pública y escritura con cualquier userId válido
        allow read: if true;
        allow write: if userId != null && userId != "";
    }

    // Perfiles de usuario: Solo el propio usuario puede leer y escribir su perfil.
    match /userProfiles/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Publicaciones de la comunidad: Lectura pública, escritura con validación de contenido
    match /community-posts/{postId} {
      allow read: if true;
      allow create: if request.resource.data.content != null && 
                      request.resource.data.content != "" &&
                      request.resource.data.authorName != null &&
                      request.resource.data.authorName != "";
      allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }

    // Comentarios de la comunidad: Lectura pública, escritura con validación
    match /community-posts/{postId}/comments/{commentId} {
      allow read: if true;
      allow create: if request.resource.data.content != null && 
                      request.resource.data.content != "" &&
                      request.resource.data.authorName != null &&
                      request.resource.data.authorName != "";
      allow update, delete: if false; // Nadie puede editar o borrar comentarios desde el cliente.
    }

    // Tokens para notificaciones: Solo el usuario puede gestionar su propio token.
    match /fcmTokens/{token} {
      allow write: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if false; // Nadie debería poder leer la lista de tokens.
    }
  }
}
