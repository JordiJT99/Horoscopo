rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regla por defecto: denegar todo para forzar reglas explícitas.
    match /{document=**} {
      allow read, write: if false;
    }

    // Horóscopos diarios: Lectura pública, escritura permitida para generar contenido
    match /horoscopes/daily/{date}/{locale} {
      allow read: if true;
      allow write: if true; // Permitir escritura para la generación automática
    }
    
    // Horóscopos semanales: Lectura pública, escritura permitida para generar contenido
    match /horoscopes/weekly/{weekKey}/{locale} {
      allow read: if true;
      allow write: if true; // Permitir escritura para la generación automática
    }
    
    // Horóscopos mensuales: Lectura pública, escritura permitida para generar contenido
    match /horoscopes/monthly/{monthKey}/{locale} {
      allow read: if true;
      allow write: if true; // Permitir escritura para la generación automática
    }
    
    match /horoscopes/personalized/{date}/{locale}/{sign}/{userId} {
        // Un usuario autenticado solo puede leer y escribir su propio horóscopo personalizado.
        allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Perfiles de usuario: Solo el propio usuario puede leer y escribir su perfil.
    match /userProfiles/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Publicaciones de la comunidad: Cualquiera puede leer, solo autenticados pueden crear.
    match /community-posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }

    // Comentarios de la comunidad: Cualquiera puede leer, solo autenticados pueden crear.
    match /community-posts/{postId}/comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if false; // Nadie puede editar o borrar comentarios desde el cliente.
    }

    // Tokens para notificaciones: Solo el usuario puede gestionar su propio token.
    match /fcmTokens/{token} {
      allow write: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if false; // Nadie debería poder leer la lista de tokens.
    }
  }
}
